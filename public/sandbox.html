<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: auto;
    }
  </style>
  <script>
    // Set up message listener BEFORE document is ready
    // This ensures it persists even after document.write()
    (function() {
      // Demo page iframe reference (for chrome.scripting mock)
      let demoPageFrame = null;

      // Listen for messages from the parent
      window.addEventListener('message', function(event) {
        // Verify origin for security
        if (event.source !== window.parent) return;

        if (event.data.type === 'RENDER_HTML') {
          console.log('Sandbox received RENDER_HTML message');

          // Clear any existing demo page
          const existingDemo = document.getElementById('demo-page-container');
          if (existingDemo) {
            existingDemo.remove();
            demoPageFrame = null;
          }

          // Clear the body and inject new HTML
          document.body.innerHTML = event.data.html;

          // Execute any scripts in the new HTML
          const scripts = document.body.getElementsByTagName('script');
          for (let i = 0; i < scripts.length; i++) {
            const oldScript = scripts[i];
            const newScript = document.createElement('script');

            // Copy attributes
            Array.from(oldScript.attributes).forEach(attr => {
              newScript.setAttribute(attr.name, attr.value);
            });

            // Copy script content
            newScript.textContent = oldScript.textContent;

            // Replace old script with new one to execute it
            oldScript.parentNode.replaceChild(newScript, oldScript);
          }
          console.log('Sandbox rendered HTML');
        }
      });

      // Notify parent that sandbox is ready
      window.parent.postMessage({ type: 'SANDBOX_READY' }, '*');
    })();
  </script>
</head>
<body>
</body>
</html>
