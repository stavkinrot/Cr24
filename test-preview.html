<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Preview System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Chrome Extension Preview System Test</h1>
    
    <div class="test-container">
        <h2>Test 1: CSP Compliance</h2>
        <p>Testing if the preview system can load extensions without CSP violations.</p>
        <button class="test-button" onclick="testCSPCompliance()">Test CSP Compliance</button>
        <div id="csp-result" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>Test 2: Script Injection</h2>
        <p>Testing if scripts are properly injected via postMessage.</p>
        <button class="test-button" onclick="testScriptInjection()">Test Script Injection</button>
        <div id="script-result" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>Test 3: Chrome API Simulation</h2>
        <p>Testing if Chrome APIs are properly simulated in preview mode.</p>
        <button class="test-button" onclick="testChromeAPI()">Test Chrome API</button>
        <div id="chrome-result" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>Test 4: Extension Preview</h2>
        <p>Testing the actual extension preview functionality.</p>
        <button class="test-button" onclick="testExtensionPreview()">Test Extension Preview</button>
        <div id="preview-result" class="result"></div>
        <div id="preview-container" style="width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 10px;"></div>
    </div>

    <script>
        // Test functions
        function testCSPCompliance() {
            const result = document.getElementById('csp-result');
            try {
                // Check if we can create blob URLs without CSP violations
                const testScript = 'console.log("CSP test script executed");';
                const blob = new Blob([testScript], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                
                // Try to create a script element (this would fail with CSP violations)
                const script = document.createElement('script');
                script.src = url;
                
                result.innerHTML = '✅ CSP Compliance Test: Blob URL creation successful';
                result.className = 'result success';
                
                // Clean up
                URL.revokeObjectURL(url);
            } catch (error) {
                result.innerHTML = `❌ CSP Compliance Test Failed: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        function testScriptInjection() {
            const result = document.getElementById('script-result');
            try {
                // Simulate the postMessage script injection
                const testScript = `
                    console.log('Script injection test executed');
                    window.testInjectionSuccess = true;
                `;
                
                // Create a test iframe
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                // Wait for iframe to load
                iframe.onload = () => {
                    try {
                        iframe.contentWindow.postMessage({
                            type: 'EXECUTE_SCRIPT',
                            script: testScript
                        }, '*');
                        
                        setTimeout(() => {
                            const success = iframe.contentWindow.testInjectionSuccess;
                            if (success) {
                                result.innerHTML = '✅ Script Injection Test: Successfully injected script via postMessage';
                                result.className = 'result success';
                            } else {
                                result.innerHTML = '❌ Script Injection Test: Script execution failed';
                                result.className = 'result error';
                            }
                            document.body.removeChild(iframe);
                        }, 100);
                    } catch (error) {
                        result.innerHTML = `❌ Script Injection Test Failed: ${error.message}`;
                        result.className = 'result error';
                        document.body.removeChild(iframe);
                    }
                };
                
                iframe.src = 'data:text/html,<html><body>Test iframe</body></html>';
                
            } catch (error) {
                result.innerHTML = `❌ Script Injection Test Failed: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        function testChromeAPI() {
            const result = document.getElementById('chrome-result');
            try {
                // Test if Chrome API shim would work
                const chromeAPITest = `
                    // Simulate Chrome API shim
                    if (typeof chrome === 'undefined') {
                        window.chrome = {
                            runtime: {
                                sendMessage: function(msg, callback) {
                                    console.log('Chrome runtime.sendMessage simulated:', msg);
                                    if (callback) callback({success: true});
                                },
                                id: 'test-extension-id'
                            },
                            storage: {
                                local: {
                                    get: function(keys, callback) {
                                        console.log('Chrome storage.local.get simulated:', keys);
                                        if (callback) callback({});
                                    },
                                    set: function(items, callback) {
                                        console.log('Chrome storage.local.set simulated:', items);
                                        if (callback) callback();
                                    }
                                }
                            }
                        };
                    }
                    
                    // Test the APIs
                    if (typeof chrome !== 'undefined' && chrome.runtime && chrome.storage) {
                        window.chromeAPITestSuccess = true;
                        console.log('Chrome API simulation successful');
                    }
                `;
                
                // Execute the test
                eval(chromeAPITest);
                
                if (window.chromeAPITestSuccess) {
                    result.innerHTML = '✅ Chrome API Test: API simulation successful';
                    result.className = 'result success';
                } else {
                    result.innerHTML = '❌ Chrome API Test: API simulation failed';
                    result.className = 'result error';
                }
            } catch (error) {
                result.innerHTML = `❌ Chrome API Test Failed: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        function testExtensionPreview() {
            const result = document.getElementById('preview-result');
            const container = document.getElementById('preview-container');
            
            try {
                // Create test extension files
                const testFiles = [
                    {
                        path: 'manifest.json',
                        content: JSON.stringify({
                            "manifest_version": 3,
                            "name": "Test Counter",
                            "version": "1.0",
                            "action": {
                                "default_popup": "popup.html"
                            },
                            "permissions": ["storage"]
                        }, null, 2)
                    },
                    {
                        path: 'popup.html',
                        content: `<!DOCTYPE html>
<html>
<head>
    <title>Test Counter</title>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        button { padding: 10px; margin: 5px; }
        #counter { font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Test Counter</h1>
    <div id="counter">0</div>
    <button id="increment">Increment</button>
    <button id="reset">Reset</button>
    <div id="result"></div>
</body>
</html>`
                    },
                    {
                        path: 'popup.js',
                        content: `let count = 0;

document.getElementById('increment').addEventListener('click', () => {
    count++;
    document.getElementById('counter').textContent = count;
    document.getElementById('result').textContent = 'Count: ' + count;
});

document.getElementById('reset').addEventListener('click', () => {
    count = 0;
    document.getElementById('counter').textContent = count;
    document.getElementById('result').textContent = 'Reset!';
});

console.log('Test extension loaded successfully!');`
                    }
                ];
                
                // Create preview iframe
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                container.appendChild(iframe);
                
                // Create HTML with the test extension
                let html = testFiles.find(f => f.path === 'popup.html').content;
                
                // Add base href and scripts
                html = html.replace('</head>', '<base href="blob:test/">\n</head>');
                html = html.replace('</body>', '<script>console.log("Test extension script loaded");</script>\n</body>');
                
                // Create blob URL for the HTML
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                iframe.onload = () => {
                    try {
                        // Test if the extension works
                        const iframeDoc = iframe.contentDocument;
                        const counter = iframeDoc.getElementById('counter');
                        const incrementBtn = iframeDoc.getElementById('increment');
                        
                        if (counter && incrementBtn) {
                            // Simulate a click
                            incrementBtn.click();
                            
                            setTimeout(() => {
                                if (counter.textContent === '1') {
                                    result.innerHTML = '✅ Extension Preview Test: Counter functionality works!';
                                    result.className = 'result success';
                                } else {
                                    result.innerHTML = '❌ Extension Preview Test: Counter functionality failed';
                                    result.className = 'result error';
                                }
                            }, 100);
                        } else {
                            result.innerHTML = '❌ Extension Preview Test: Elements not found';
                            result.className = 'result error';
                        }
                    } catch (error) {
                        result.innerHTML = `❌ Extension Preview Test Failed: ${error.message}`;
                        result.className = 'result error';
                    }
                };
                
            } catch (error) {
                result.innerHTML = `❌ Extension Preview Test Failed: ${error.message}`;
                result.className = 'result error';
            }
        }
        
        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            console.log('Preview System Test Page Loaded');
            console.log('Available tests:');
            console.log('1. testCSPCompliance()');
            console.log('2. testScriptInjection()');
            console.log('3. testChromeAPI()');
            console.log('4. testExtensionPreview()');
        });
    </script>
</body>
</html>


